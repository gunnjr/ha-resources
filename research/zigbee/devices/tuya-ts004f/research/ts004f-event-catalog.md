# TS004F Rotary Knob - Event Catalog

## Overview

This document catalogs all ZHA events generated by the TS004F rotary knob device across different physical interactions. The goal is to provide a comprehensive reference for building Home Assistant automations.

**Test Date:** 2025-11-15
**Device:** TS004F (a4:c1:38:7d:21:bd:e8:bf)
**ZHA Events Captured:** 147 events across 15 distinct physical actions

---

## Key Findings Summary

### Event Structure
All events share this base structure:
- `cluster_id`: Zigbee cluster (6=OnOff, 8=LevelControl, 768=ColorControl)
- `command`: The specific command name
- `endpoint_id`: Always 1 for this device
- `device_id` / `device_ieee`: Device identifiers
- `params`: Command-specific parameters
- `args`: Ordered argument list

### Critical Parameters for Automation

#### For Rotation Events (Dimmer Control)
- **`step_mode`** (in cluster 8 `step` command):
  - `0` = Rotate RIGHT (clockwise) / Brightness UP
  - `1` = Rotate LEFT (counter-clockwise) / Brightness DOWN

- **`step_size`** (magnitude of change):
  - `13` = Single slow notch
  - `26` = Two notches or slightly faster single notch
  - `52-78` = Fast rotation (accumulated)
  - `91+` = Very fast rotation (accumulated)

- **`transition_time`** (speed indicator):
  - `1` = Fast rotation
  - `2` = Moderate/slow rotation
  - `3` = Slow rotation with larger accumulated step

#### For Button Press Events
- **`press_type`**:
  - `0` = Single press
  - `1` = Double press
  - `2` = Long press

#### For Direction Events
- **`rotate_type`**:
  - `0` = RIGHT (clockwise)
  - `1` = LEFT (counter-clockwise)

---

## Mode Switching Behavior

The device has two modes that affect rotation event generation:

### Mode 1 (Default - `switch_mode=0`)
Rotation generates **3 events**:
1. `right` or `left` command (cluster 6)
2. `rotate_type` command (cluster 6)
3. `step` command (cluster 8) ← **Critical for dimmer automation**

### Mode 2 (`switch_mode=1`)
Rotation generates **2 events only**:
1. `right` or `left` command (cluster 6)
2. `rotate_type` command (cluster 6)
3. **NO `step` command** ← No cluster 8 events!

**Mode Change Trigger:** Triple-click the button
**Mode Change Event:** `attribute_updated` with `attribute_name: "switch_mode"`

---

## Action-by-Action Event Catalog

### Action 1: Single Click

**Physical Action:** Press and quickly release the button once

**Events Generated (3 events):**
```json
1. {"cluster_id": 6, "command": "remote_button_short_press", "params": {}}
2. {"cluster_id": 6, "command": "press_type", "params": {"press_type": 0}}
3. {"cluster_id": 6, "command": "toggle", "params": {}}
```

**Automation Trigger:**
```yaml
trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: YOUR_DEVICE_ID
      command: remote_button_short_press
```

**Notes:**
- The `toggle` command follows ~250ms after the press event
- `press_type: 0` confirms single press

---

### Action 2: Double Click

**Physical Action:** Press button twice in quick succession

**Events Generated (3 events):**
```json
1. {"cluster_id": 6, "command": "remote_button_double_press", "params": {}}
2. {"cluster_id": 6, "command": "press_type", "params": {"press_type": 1}}
3. {"cluster_id": 6, "command": "on", "params": {}}
```

**Automation Trigger:**
```yaml
trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: YOUR_DEVICE_ID
      command: remote_button_double_press
```

**Notes:**
- Generates `on` command instead of `toggle`
- `press_type: 1` confirms double press

---

### Action 3: Long Press (Hold)

**Physical Action:** Press and hold button for 2-3 seconds

**Events Generated (6+ events):**
```json
1. {"cluster_id": 768, "command": "move_saturation", "params": {"move_mode": 1, "rate": 200}}
2. {"cluster_id": 6, "command": "remote_button_long_press", "params": {}}
3. {"cluster_id": 6, "command": "press_type", "params": {"press_type": 2}}
4. {"cluster_id": 768, "command": "move_saturation", ...}
5. {"cluster_id": 768, "command": "move_hue", "params": {"move_mode": 1, "rate": 15}}
6. {"cluster_id": 768, "command": "stop_move_step", ...}
```

**Automation Trigger:**
```yaml
trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: YOUR_DEVICE_ID
      command: remote_button_long_press
```

**Notes:**
- Generates color control commands (cluster 768)
- `press_type: 2` confirms long press
- Multiple `stop_move_step` commands may fire on release

---

### Action 4: Rotate RIGHT Slow (Mode 1)

**Physical Action:** Slowly rotate knob clockwise, ~1-2 notches per second

**Events Per Notch (3 events):**
```json
1. {"cluster_id": 6, "command": "right", "params": {}}
2. {"cluster_id": 6, "command": "rotate_type", "params": {"rotate_type": 0}}
3. {
     "cluster_id": 8,
     "command": "step",
     "params": {
       "step_mode": 0,          // 0 = right/up
       "step_size": 13,         // Small step = slow rotation
       "transition_time": 2     // 2 = slower speed
     }
   }
```

**Automation Example (Dimmer Increase):**
```yaml
trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: YOUR_DEVICE_ID
      command: step
      cluster_id: 8
      params:
        step_mode: 0  # RIGHT rotation

action:
  - service: light.turn_on
    target:
      entity_id: light.your_light
    data:
      brightness_step_pct: "{{ trigger.event.data.params.step_size / 2 }}"
```

**Notes:**
- First notch often has `transition_time: 2`, subsequent notches may show `transition_time: 1` as rotation continues
- Each notch generates the full 3-event sequence
- **This is the primary automation pattern for dimmer increase**

---

### Action 5: Rotate RIGHT Fast

**Physical Action:** Rapidly spin knob clockwise

**Events Generated (3 events per rotation burst):**
```json
1. {"cluster_id": 6, "command": "right", "params": {}}
2. {"cluster_id": 6, "command": "rotate_type", "params": {"rotate_type": 0}}
3. {
     "cluster_id": 8,
     "command": "step",
     "params": {
       "step_mode": 0,          // 0 = right/up
       "step_size": 52-78,      // LARGER step = accumulated fast rotation
       "transition_time": 2-3   // Can be 2 or 3
     }
   }
```

**Automation Considerations:**
- `step_size` varies significantly: observed values 52, 78
- Fast rotation generates fewer event bursts but larger step_size values
- May want to cap brightness changes to avoid overshooting

**Notes:**
- Device accumulates rotation speed into larger step_size values
- Less frequent events than slow rotation, but bigger jumps

---

### Action 6: Rotate LEFT Slow (Mode 1)

**Physical Action:** Slowly rotate knob counter-clockwise, ~1-2 notches per second

**Events Per Notch (3 events):**
```json
1. {"cluster_id": 6, "command": "left", "params": {}}
2. {"cluster_id": 6, "command": "rotate_type", "params": {"rotate_type": 1}}
3. {
     "cluster_id": 8,
     "command": "step",
     "params": {
       "step_mode": 1,          // 1 = left/down
       "step_size": 13,         // Small step = slow rotation
       "transition_time": 2     // 2 = slower speed
     }
   }
```

**Automation Example (Dimmer Decrease):**
```yaml
trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: YOUR_DEVICE_ID
      command: step
      cluster_id: 8
      params:
        step_mode: 1  # LEFT rotation

action:
  - service: light.turn_on
    target:
      entity_id: light.your_light
    data:
      brightness_step_pct: "{{ -(trigger.event.data.params.step_size / 2) }}"
```

**Notes:**
- Mirror of Action 4, but with `step_mode: 1` for LEFT
- **Primary automation pattern for dimmer decrease**

---

### Action 7: Rotate LEFT Fast

**Physical Action:** Rapidly spin knob counter-clockwise

**Events Generated (3 events per rotation burst):**
```json
1. {"cluster_id": 6, "command": "left", "params": {}}
2. {"cluster_id": 6, "command": "rotate_type", "params": {"rotate_type": 1}}
3. {
     "cluster_id": 8,
     "command": "step",
     "params": {
       "step_mode": 1,          // 1 = left/down
       "step_size": 26-91,      // LARGER step = accumulated fast rotation
       "transition_time": 1-3   // Varies
     }
   }
```

**Notes:**
- Observed `step_size` values: 26, 91
- Similar to Action 5, but direction reversed

---

### Action 8: Press + Rotate RIGHT Slow

**Physical Action:** Hold button down, then slowly rotate clockwise

**Events Generated (different cluster!):**
```json
1. {"cluster_id": 6, "command": "right", "params": {}}
2. {"cluster_id": 6, "command": "rotate_type", "params": {"rotate_type": 0}}
3. {
     "cluster_id": 768,         // Color Control, NOT LevelControl!
     "command": "step_color_temp",
     "params": {
       "step_mode": 1,
       "step_size": 18-36,      // Color temp step
       "transition_time": 1,
       "color_temp_min_mireds": 153,
       "color_temp_max_mireds": 500
     }
   }
4. {"cluster_id": 6, "command": "remote_button_long_press", "params": {}}
5. {"cluster_id": 6, "command": "press_type", "params": {"press_type": 2}}
```

**Automation Example (Color Temperature Warmer):**
```yaml
trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: YOUR_DEVICE_ID
      command: step_color_temp
      cluster_id: 768

condition:
  - condition: template
    value_template: "{{ trigger.event.data.command == 'right' or (trigger.event.data.params.step_mode == 1 and trigger.event.data.cluster_id == 768) }}"

action:
  - service: light.turn_on
    target:
      entity_id: light.your_light
    data:
      color_temp: "{{ state_attr('light.your_light', 'color_temp') | int + trigger.event.data.params.step_size }}"
```

**Notes:**
- **IMPORTANT:** Generates `step_color_temp` (cluster 768), NOT regular `step` (cluster 8)
- This means press+rotate won't trigger standard dimmer automations
- Long press event comes DURING the rotation sequence
- Intended for color temperature or hue adjustments

---

### Action 9: Press + Rotate RIGHT Fast

**Physical Action:** Hold button down, then rapidly rotate clockwise

**Expected Events:**
- Similar to Action 8, but with larger `step_size` values
- `cluster_id: 768` for `step_color_temp`
- Larger accumulated step values

**Notes:**
- Pattern similar to Action 8, watch for larger step_size in cluster 768 events

---

### Action 10: Press + Rotate LEFT Slow

**Physical Action:** Hold button down, then slowly rotate counter-clockwise

**Events Generated:**
```json
1. {"cluster_id": 6, "command": "left", "params": {}}
2. {"cluster_id": 6, "command": "rotate_type", "params": {"rotate_type": 1}}
3. {
     "cluster_id": 768,         // Color Control
     "command": "step_color_temp",
     "params": {
       "step_mode": 3,          // Different step_mode for LEFT in color temp
       "step_size": 10-20,
       "transition_time": 1,
       "color_temp_min_mireds": 153,
       "color_temp_max_mireds": 500
     }
   }
4. {"cluster_id": 6, "command": "remote_button_long_press", "params": {}}
```

**Automation Example (Color Temperature Cooler):**
```yaml
trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: YOUR_DEVICE_ID
      command: step_color_temp
      cluster_id: 768

condition:
  - condition: template
    value_template: "{{ trigger.event.data.command == 'left' or (trigger.event.data.params.step_mode == 3 and trigger.event.data.cluster_id == 768) }}"

action:
  - service: light.turn_on
    target:
      entity_id: light.your_light
    data:
      color_temp: "{{ state_attr('light.your_light', 'color_temp') | int - trigger.event.data.params.step_size }}"
```

**Notes:**
- `step_mode: 3` for LEFT in color temperature context (vs `step_mode: 1` in cluster 8)
- Mirror of Action 8 for opposite direction

---

### Action 11: Press + Rotate LEFT Fast

**Physical Action:** Hold button down, then rapidly rotate counter-clockwise

**Expected Events:**
- Similar to Action 10, but with larger `step_size` values
- `cluster_id: 768` for `step_color_temp`
- `step_mode: 3` for LEFT direction

---

### Action 12: Triple Click → Mode 2

**Physical Action:** Click button three times rapidly to switch device mode

**Events Generated:**
```json
1. {
     "cluster_id": 6,
     "command": "attribute_updated",
     "args": {
       "attribute_id": 32772,
       "attribute_name": "switch_mode",
       "attribute_value": 1,
       "value": 1
     }
   }
```

**Automation to Detect Mode Change:**
```yaml
trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: YOUR_DEVICE_ID
      command: attribute_updated
      cluster_id: 6

condition:
  - condition: template
    value_template: "{{ trigger.event.data.args.attribute_name == 'switch_mode' }}"

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ trigger.event.data.args.value == 1 }}"
        sequence:
          - service: notify.notify
            data:
              message: "TS004F switched to Mode 2"
      - conditions:
          - condition: template
            value_template: "{{ trigger.event.data.args.value == 0 }}"
        sequence:
          - service: notify.notify
            data:
              message: "TS004F switched to Mode 1"
```

**Notes:**
- `switch_mode: 1` = Mode 2 (alternate mode)
- **In Mode 2, rotation does NOT generate cluster 8 `step` events!**
- Mode 2 is not recommended for dimmer control

---

### Action 13: Rotate RIGHT Slow (Mode 2)

**Physical Action:** While in Mode 2, slowly rotate knob clockwise

**Events Generated (2 events only - NO cluster 8!):**
```json
1. {"cluster_id": 6, "command": "right", "params": {}}
2. {"cluster_id": 6, "command": "rotate_type", "params": {"rotate_type": 0}}
```

**Critical Observation:**
- **NO `step` command (cluster 8) is generated!**
- Only direction indication events fire
- **Dimmer automations based on cluster 8 `step` will NOT work in Mode 2**

**Notes:**
- This confirms Mode 2 is not suitable for dimmer control via cluster 8 events
- Would require alternative automation strategy based on `right`/`left` commands

---

### Action 14: Triple Click → Mode 1

**Physical Action:** Click button three times to return to Mode 1

**Events Generated:**
```json
1. {
     "cluster_id": 6,
     "command": "attribute_updated",
     "args": {
       "attribute_id": 32772,
       "attribute_name": "switch_mode",
       "attribute_value": 0,
       "value": 0
     }
   }
```

**Notes:**
- `switch_mode: 0` = Mode 1 (default mode)
- Restores cluster 8 `step` event generation for rotations

---

### Action 15: Rotate RIGHT Slow (Verify Mode 1 Restored)

**Physical Action:** Slowly rotate clockwise to verify Mode 1 behavior

**Events Generated (3 events - cluster 8 restored!):**
```json
1. {"cluster_id": 6, "command": "right", "params": {}}
2. {"cluster_id": 6, "command": "rotate_type", "params": {"rotate_type": 0}}
3. {
     "cluster_id": 8,
     "command": "step",
     "params": {
       "step_mode": 0,
       "step_size": 13,
       "transition_time": 2
     }
   }
```

**Notes:**
- Confirms Mode 1 restored: cluster 8 `step` events working again
- Events match Action 4 pattern exactly

---

## Recommended Automation Strategy

### For Dimmer Control (Brightness)

**Use Mode 1 (default) and trigger on cluster 8 `step` commands:**

```yaml
automation:
  - alias: "TS004F Dimmer Control"
    trigger:
      - platform: event
        event_type: zha_event
        event_data:
          device_id: YOUR_DEVICE_ID
          command: step
          cluster_id: 8

    action:
      - variables:
          step_mode: "{{ trigger.event.data.params.step_mode }}"
          step_size: "{{ trigger.event.data.params.step_size }}"
          # Convert to brightness percentage change
          # step_size 13 = ~6-7% brightness change
          brightness_change: "{{ (step_size / 2) if step_mode == 0 else -(step_size / 2) }}"

      - service: light.turn_on
        target:
          entity_id: light.your_light
        data:
          brightness_step_pct: "{{ brightness_change }}"
```

### For Color Temperature Control

**Use press+rotate (cluster 768 events):**

```yaml
automation:
  - alias: "TS004F Color Temp Control"
    trigger:
      - platform: event
        event_type: zha_event
        event_data:
          device_id: YOUR_DEVICE_ID
          command: step_color_temp
          cluster_id: 768

    action:
      - variables:
          step_mode: "{{ trigger.event.data.params.step_mode }}"
          step_size: "{{ trigger.event.data.params.step_size }}"
          current_temp: "{{ state_attr('light.your_light', 'color_temp') | int }}"
          # step_mode 1 = warmer (increase mireds), step_mode 3 = cooler (decrease mireds)
          new_temp: "{{ (current_temp + step_size) if step_mode == 1 else (current_temp - step_size) }}"

      - service: light.turn_on
        target:
          entity_id: light.your_light
        data:
          color_temp: "{{ [153, [new_temp, 500] | min] | max }}"  # Clamp to valid range
```

### For Button Actions

**Single/Double/Long press for discrete functions:**

```yaml
automation:
  - alias: "TS004F Button Actions"
    trigger:
      - platform: event
        event_type: zha_event
        event_data:
          device_id: YOUR_DEVICE_ID
          cluster_id: 6

    action:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.command == 'remote_button_short_press' }}"
            sequence:
              - service: light.toggle
                target:
                  entity_id: light.your_light

          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.command == 'remote_button_double_press' }}"
            sequence:
              - service: light.turn_on
                target:
                  entity_id: light.your_light
                data:
                  brightness_pct: 100

          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.command == 'remote_button_long_press' }}"
            sequence:
              - service: scene.turn_on
                target:
                  entity_id: scene.your_scene
```

---

## Event Timing Observations

- Events within an action burst are typically 0.25-0.5 seconds apart
- Slow rotations: Each notch generates events ~0.25-0.5s apart
- Fast rotations: Events are more spaced but with accumulated step_size
- Button press sequences: ~0.25s between command events
- Mode switch detection: ~250ms after triple-click action

---

## Cluster Reference

| Cluster ID | Cluster Name | Purpose |
|------------|--------------|---------|
| 6 | OnOff | Button press events, rotation direction |
| 8 | LevelControl | Brightness/dimmer step commands (Mode 1 rotation) |
| 768 | ColorControl | Color temperature/hue commands (press+rotate) |

---

## Troubleshooting

### Dimmer not responding to rotation
- **Check device mode:** Ensure `switch_mode = 0` (Mode 1)
- **Verify cluster 8 events:** Mode 2 does not generate cluster 8 `step` commands
- **Solution:** Triple-click to return to Mode 1

### Press+rotate not working for color temp
- **Check trigger:** Must use `cluster_id: 768` and `command: step_color_temp`
- **Note:** These events do NOT trigger cluster 8 automations

### Inconsistent step_size values
- **Expected:** `step_size` varies based on rotation speed
- **Fast rotation:** Device accumulates rotation into larger step values (52-91)
- **Slow rotation:** Individual notches show smaller, consistent values (~13)
- **Solution:** Use relative brightness_step_pct rather than absolute values

---

## Appendix: Raw Event Examples

### Single Notch Right (Slow)
```json
{"args": [], "cluster_id": 6, "command": "right", "endpoint_id": 1, "params": {}}
{"args": [0], "cluster_id": 6, "command": "rotate_type", "endpoint_id": 1, "params": {"rotate_type": 0}}
{"args": [0, 13, 2], "cluster_id": 8, "command": "step", "endpoint_id": 1, "params": {"step_mode": 0, "step_size": 13, "transition_time": 2}}
```

### Single Button Press
```json
{"args": [], "cluster_id": 6, "command": "remote_button_short_press", "endpoint_id": 1, "params": {}}
{"args": [0], "cluster_id": 6, "command": "press_type", "endpoint_id": 1, "params": {"press_type": 0}}
{"args": [], "cluster_id": 6, "command": "toggle", "endpoint_id": 1, "params": {}}
```

### Mode Switch to Mode 2
```json
{"args": {"attribute_id": 32772, "attribute_name": "switch_mode", "attribute_value": 1, "value": 1}, "cluster_id": 6, "command": "attribute_updated", "endpoint_id": 1, "params": {}}
```

---

**Document Version:** 1.0
**Last Updated:** 2025-11-15
**Test Session Log:** `captured_logs/ts004f-events-capture.log`
