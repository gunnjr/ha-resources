blueprint:
  name: ZHA - Tuya TS004F Smart Knob - Enhanced (Mode-Aware)

  description: >-
    **Enhanced TS004F rotary knob automation with proper mode detection.**


    This blueprint provides complete control for the Tuya TS004F rotary knob in Home Assistant ZHA.


    **IMPORTANT:** The device has two modes controlled by triple-clicking:

    - **Dimmer Mode (Recommended):** Full dimming support via cluster 8 step commands

    - **Scene Control Mode:** NO dimming support - only direction events


    **Recommendation:** Keep device in Dimmer Mode and use this blueprint's built-in actions.


    **Features:**

    - Automatic brightness dimming with speed detection (accounts for rotation speed)

    - Color temperature control (press + rotate, with safe bounds checking)

    - Customizable button actions (single, double, long press)

    - Optional auto-toggle on single press

    - Mode switch detection with optional tracking and notifications

    - Works with multiple TS004F manufacturer variants (_TZ3000_4fjiwweb, _TZ3000_qja6nq5z, etc.)


    **Device Behavior Notes:**

    - Single press generates a "toggle" command (~250ms after button press)

    - Double press generates an "on" command instead of toggle

    - Long press triggers color control commands (move_hue, move_saturation)

    - Press + rotate uses cluster 768 (color temp), not cluster 8 (brightness)

    - Scene Control Mode disables ALL cluster 8 events (breaks dimming completely)


    Based on comprehensive 147-event analysis. See full documentation: https://github.com/YOUR_REPO

  domain: automation

  source_url: https://github.com/YOUR_REPO/examples/enhanced-blueprint.yaml

  input:
    # Device Selection
    remote:
      name: TS004F Rotary Knob
      description: Select your TS004F device (works with all manufacturer variants)
      selector:
        device:
          integration: zha
          model: TS004F

    # Mode 1: Dimming Target
    dimmer_light:
      name: Light for Brightness Control
      description: "Light to control with rotation (Mode 1 - cluster 8 step commands)"
      selector:
        target:
          entity:
            domain: light
      default: {}

    # Mode 1: Color Temp Target
    color_temp_light:
      name: Light for Color Temperature Control
      description: "Light to control with press + rotate (cluster 768)"
      selector:
        target:
          entity:
            domain: light
      default: {}

    # Button Actions
    button_single_press:
      name: Single Press Action
      description: "Action to perform on single button press"
      selector:
        action:
      default: []

    button_double_press:
      name: Double Press Action
      description: "Action to perform on double button press"
      selector:
        action:
      default: []

    button_long_press:
      name: Long Press Action
      description: "Action to perform on long button press"
      selector:
        action:
      default: []

    # Auto-Toggle Feature
    auto_toggle_single_press:
      name: Auto-Toggle on Single Press
      description: "Automatically toggle the dimmer light when single-pressing the button (happens ~250ms after button press)"
      default: false
      selector:
        boolean:

    # Mode Switch Notification
    notify_mode_switch:
      name: Notify on Mode Switch
      description: "Send notification when device switches modes (triple-click detection)"
      default: false
      selector:
        boolean:

    notification_service:
      name: Notification Service
      description: "Service to use for mode switch notifications (e.g., notify.mobile_app_phone)"
      default: "notify.notify"
      selector:
        text:

    mode_sensor:
      name: Mode Status Tracker (Optional)
      description: >-
        Optional: Select an input_select helper to track which mode the device is in.


        **First-time setup:**

        1. Go to Settings → Devices & Services → Helpers

        2. Click "+ Create Helper" → Dropdown

        3. Name it (e.g., "TS004F Mode Status")

        4. Add these TWO options with exact text:
           - Dimmer Mode
           - Scene Control Mode

        5. Set initial value to "Dimmer Mode"

        6. Save, then return here and select it


        The automation will update this helper when you triple-click to switch modes.
      selector:
        entity:
          domain: input_select
      default: {}

    # Advanced Settings
    brightness_step_multiplier:
      name: Brightness Step Multiplier
      description: "Adjust dimming speed (1.0 = normal, 0.5 = half speed, 2.0 = double speed)"
      default: 1.0
      selector:
        number:
          min: 0.1
          max: 5.0
          step: 0.1
          mode: slider

    mode:
      name: Automation Mode
      description: "https://www.home-assistant.io/docs/automation/modes/"
      default: restart
      selector:
        select:
          mode: dropdown
          options:
            - single
            - restart
            - queued
            - parallel

mode: !input mode
max_exceeded: silent

trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: !input remote

action:
  - variables:
      command: "{{ trigger.event.data.command }}"
      cluster_id: "{{ trigger.event.data.cluster_id }}"
      endpoint_id: "{{ trigger.event.data.endpoint_id }}"
      params: "{{ trigger.event.data.params }}"

      # Extract rotation parameters from cluster 8 step commands
      step_mode: "{{ params.step_mode if params.step_mode is defined else -1 }}"
      step_size: "{{ params.step_size if params.step_size is defined else 0 }}"
      transition_time: "{{ params.transition_time if params.transition_time is defined else 2 }}"

      # Calculate brightness change (step_size / 2 = reasonable percentage)
      brightness_multiplier: !input brightness_step_multiplier
      brightness_change: >-
        {{ (step_size / 2 * brightness_multiplier) | round(0) }}

      # Map transition_time to actual speed
      # 1 = fast (0.3s), 2 = moderate (0.5s), 3 = slow (0.8s)
      transition_speed: >-
        {% if transition_time == 1 %} 0.3
        {% elif transition_time == 2 %} 0.5
        {% elif transition_time == 3 %} 0.8
        {% else %} 0.5
        {% endif %}

      # Color temp step_mode: 1 = warmer, 3 = cooler
      color_step_mode: "{{ params.step_mode if command == 'step_color_temp' else -1 }}"
      color_step_size: "{{ params.step_size if command == 'step_color_temp' else 0 }}"

      # Extract attribute_updated parameters
      updated_attrib_name: "{{ trigger.event.data.args.attribute_name if command == 'attribute_updated' else '' }}"
      updated_attrib_value: "{{ trigger.event.data.args.value if command == 'attribute_updated' else -1 }}"

      # Boolean input variables for use in conditions
      auto_toggle_enabled: !input auto_toggle_single_press
      notify_enabled: !input notify_mode_switch
      mode_sensor_entity: !input mode_sensor


    
  - choose:

    # ============================================
    # MODE 1: BRIGHTNESS DIMMING (Cluster 8)
    # ============================================

    - conditions:
        - "{{ command == 'step' }}"
        - "{{ cluster_id == 8 }}"
        - "{{ endpoint_id == 1 }}"
        - "{{ step_mode == 0 }}"  # Rotate RIGHT = brightness UP
      sequence:
        - service: light.turn_on
          target: !input dimmer_light
          data:
            brightness_step_pct: "{{ brightness_change }}"
            transition: "{{ transition_speed }}"

    - conditions:
        - "{{ command == 'step' }}"
        - "{{ cluster_id == 8 }}"
        - "{{ endpoint_id == 1 }}"
        - "{{ step_mode == 1 }}"  # Rotate LEFT = brightness DOWN
      sequence:
        - service: light.turn_on
          target: !input dimmer_light
          data:
            brightness_step_pct: "{{ -brightness_change }}"
            transition: "{{ transition_speed }}"

    # ============================================
    # PRESS + ROTATE: COLOR TEMPERATURE (Cluster 768)
    # ============================================

    - conditions:
        - "{{ command == 'step_color_temp' }}"
        - "{{ cluster_id == 768 }}"
        - "{{ endpoint_id == 1 }}"
        - "{{ color_step_mode == 1 }}"  # Rotate RIGHT = warmer (increase mireds)
      sequence:
        - service: light.turn_on
          target: !input color_temp_light
          data:
            color_temp: >-
              {% set current = state_attr(color_temp_light.entity_id, 'color_temp') | default(300) %}
              {% set new_temp = current + color_step_size %}
              {{ [153, [new_temp, 500] | min] | max }}
            transition: "{{ transition_speed }}"

    - conditions:
        - "{{ command == 'step_color_temp' }}"
        - "{{ cluster_id == 768 }}"
        - "{{ endpoint_id == 1 }}"
        - "{{ color_step_mode == 3 }}"  # Rotate LEFT = cooler (decrease mireds)
      sequence:
        - service: light.turn_on
          target: !input color_temp_light
          data:
            color_temp: >-
              {% set current = state_attr(color_temp_light.entity_id, 'color_temp') | default(300) %}
              {% set new_temp = current - color_step_size %}
              {{ [153, [new_temp, 500] | min] | max }}
            transition: "{{ transition_speed }}"

    # ============================================
    # BUTTON ACTIONS
    # ============================================

    - conditions:
        - "{{ command == 'remote_button_short_press' }}"
        - "{{ cluster_id == 6 }}"
      sequence: !input button_single_press

    - conditions:
        - "{{ command == 'remote_button_double_press' }}"
        - "{{ cluster_id == 6 }}"
      sequence: !input button_double_press

    - conditions:
        - "{{ command == 'remote_button_long_press' }}"
        - "{{ cluster_id == 6 }}"
      sequence: !input button_long_press

    # ============================================
    # AUTO-TOGGLE (Optional)
    # ============================================
    # The device generates a "toggle" command ~250ms after single press
    # This can optionally trigger an automatic toggle of the dimmer light

    - conditions:
        - "{{ command == 'toggle' }}"
        - "{{ cluster_id == 6 }}"
        - "{{ endpoint_id == 1 }}"
        - "{{ auto_toggle_enabled }}"
      sequence:
        - service: light.toggle
          target: !input dimmer_light

    # ============================================
    # MODE SWITCH DETECTION (Triple-Click)
    # ============================================

    - conditions:
        - "{{ command == 'attribute_updated' }}"
        - "{{ cluster_id == 6 }}"
        - "{{ updated_attrib_name == 'switch_mode' }}"
      sequence:
        - choose:
          # Switched to Scene Control Mode (args.value = 1)
          - conditions:
              - "{{ updated_attrib_value == 1 }}"
            sequence:
              # Update mode sensor if provided
              - if:
                  - "{{ mode_sensor_entity != {} }}"
                then:
                  - service: input_select.select_option
                    target:
                      entity_id: !input mode_sensor
                    data:
                      option: "Scene Control Mode"

              # Send notification if enabled
              - if:
                  - "{{ notify_enabled }}"
                then:
                  - service: !input notification_service
                    data:
                      title: "⚠️ TS004F Mode Switch"
                      message: >-
                        Device switched to Scene Control Mode.

                        WARNING: Brightness dimming is now DISABLED!

                        Triple-click again to return to Dimmer Mode for dimming support.

          # Returned to Dimmer Mode (args.value = 0)
          - conditions:
              - "{{ updated_attrib_value == 0 }}"
            sequence:
              # Update mode sensor if provided
              - if:
                  - "{{ mode_sensor_entity != {} }}"
                then:
                  - service: input_select.select_option
                    target:
                      entity_id: !input mode_sensor
                    data:
                      option: "Dimmer Mode"

              # Send notification if enabled
              - if:
                  - "{{ notify_enabled }}"
                then:
                  - service: !input notification_service
                    data:
                      title: "✅ TS004F Mode Switch"
                      message: >-
                        Device returned to Dimmer Mode.

                        Brightness dimming is now enabled.

    # ============================================
    # FALLBACK: Log unexpected events
    # ============================================
    default:
      - service: system_log.write
        data:
          message: >-
            TS004F Blueprint: Unhandled event -
            command={{ command }}, cluster={{ cluster_id }},
            params={{ params }}
          level: debug
